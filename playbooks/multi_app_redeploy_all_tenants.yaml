---
- name: Append new app to tenant
  #  hosts: bigip     # this refers to inventory on tower
  hosts: localhost    # this refers to inventory on tower
  gather_facts: false
  connection: local
    
  vars:
    uri_method: "POST"
    # default 'empty' vars to be used when first creating a new tenant
    applications: []
    # temp vars for local testing only - these will come from tower
    tower_bigip: "local-lab"


  tasks:

  - name: render template
    

    # first ensure our target directory exists
  - name: Ensure target directory exists
    file:
      dest: '../tenant-config/{{ tower_bigip }}'
      state: directory

  # copy each file over that matches the given pattern
  - name: Copy each file over that matches the given pattern
    set_fact:
      tower_tenant: "{{ item }}"
      tenant_body: "{{ lookup('template', '../j2/multi_app_macro.j2', split_lines=False) }}"
    uri:
      #url: "https://{{ inventory_hostname }}/mgmt/shared/appsvcs/declare"
      # temporary for local testing
      url: "https://10.1.1.245/mgmt/shared/appsvcs/declare"
      method: "{{ uri_method }}"
      #user: "{{ lookup('env', 'ANSIBLE_NET_USERNAME') }}"
      #password: "{{ lookup('env', 'ANSIBLE_NET_PASSWORD') }}"
      # temporary for local testing
      user: "admin"
      password: "admin"
      validate_certs: no
      body: "{{ tenant_body }}"
      body_format: json
      src: "{{ item }}"

    with_fileglob:
      - "/playbooks/files/fooapp/*"